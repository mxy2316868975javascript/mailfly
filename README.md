<p align="center">
  <img src="https://img.icons8.com/fluency/96/paper-plane.png" alt="Mailfly Logo" width="80"/>
</p>

<h1 align="center">Mailfly</h1>

<p align="center">
  <strong>åŸºäº Cloudflare Workers çš„è½»é‡çº§ä¸´æ—¶é‚®ç®±æœåŠ¡</strong>
</p>

<p align="center">
  <img src="https://img.shields.io/badge/Cloudflare-Workers-F38020?style=flat-square&logo=cloudflare&logoColor=white" alt="Cloudflare Workers"/>
  <img src="https://img.shields.io/badge/Database-D1-F38020?style=flat-square&logo=cloudflare&logoColor=white" alt="Cloudflare D1"/>
  <img src="https://img.shields.io/badge/JavaScript-ES6+-F7DF1E?style=flat-square&logo=javascript&logoColor=black" alt="JavaScript"/>
  <img src="https://img.shields.io/badge/Alpine.js-3.x-8BC0D0?style=flat-square&logo=alpine.js&logoColor=white" alt="Alpine.js"/>
  <img src="https://img.shields.io/badge/Tailwind-CSS-06B6D4?style=flat-square&logo=tailwindcss&logoColor=white" alt="Tailwind CSS"/>
  <img src="https://img.shields.io/badge/License-MIT-green?style=flat-square" alt="License"/>
</p>

<p align="center">
  <a href="#-åŠŸèƒ½ç‰¹æ€§">åŠŸèƒ½ç‰¹æ€§</a> â€¢
  <a href="#-å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</a> â€¢
  <a href="#-api-æ¥å£">API æ¥å£</a> â€¢
  <a href="#%EF%B8%8F-é…ç½®è¯´æ˜">é…ç½®è¯´æ˜</a> â€¢
  <a href="#-å¼€æºåè®®">å¼€æºåè®®</a>
</p>

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- ğŸš€ **æ— æœåŠ¡å™¨æ¶æ„** - å®Œå…¨è¿è¡Œåœ¨ Cloudflare Workers è¾¹ç¼˜ç½‘ç»œ
- ğŸ“¬ **é‚®ä»¶æ¥æ”¶** - åŸç”Ÿé›†æˆ Cloudflare Email Routing
- â±ï¸ **è‡ªåŠ¨è¿‡æœŸ** - å¯é…ç½® TTLï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸé‚®ç®±
- ğŸŒ **å¤šåŸŸåæ”¯æŒ** - æ”¯æŒé…ç½®å¤šä¸ªè‡ªå®šä¹‰åŸŸå
- ğŸ¨ **ç°ä»£åŒ–ç•Œé¢** - å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ·±è‰²æ¨¡å¼
- ğŸ”’ **éšç§ä¼˜å…ˆ** - æ— è¿½è¸ªã€æ— æ—¥å¿—ï¼Œé‚®ä»¶è‡ªåŠ¨åˆ é™¤

### é«˜çº§åŠŸèƒ½
- ğŸ”„ **å¤šé‚®ç®±åˆ‡æ¢** - åŒæ—¶ç®¡ç†å¤šä¸ªä¸´æ—¶é‚®ç®±
- â° **é‚®ç®±ç»­æœŸ** - ä¸€é”®å»¶é•¿é‚®ç®±æœ‰æ•ˆæœŸ
- ğŸ“¤ **é‚®ä»¶è½¬å‘** - è‡ªåŠ¨è½¬å‘æ–°é‚®ä»¶åˆ°æŒ‡å®šé‚®ç®±
- ğŸ—‘ï¸ **é‚®ä»¶åˆ é™¤** - å•ç‹¬åˆ é™¤æŸå°é‚®ä»¶ï¼ˆä¸å½±å“ç»Ÿè®¡ï¼‰
- ğŸ“Š **ç»Ÿè®¡é¢æ¿** - é¡¶éƒ¨å®æ—¶ç»Ÿè®¡æ  + è¯¦ç»†ç»Ÿè®¡å¼¹çª—
- ğŸ”‘ **éªŒè¯ç æå–** - è‡ªåŠ¨è¯†åˆ«é‚®ä»¶ä¸­çš„éªŒè¯ç ï¼Œä¸€é”®å¤åˆ¶
- ğŸ” **æ··åˆè´¦æˆ·ç³»ç»Ÿ** - æ”¯æŒåŒ¿åæ¨¡å¼å’Œè´¦æˆ·æ¨¡å¼
- ğŸ”‘ **å¯†é’¥ç®¡ç†** - æŸ¥çœ‹å’Œå¯¼å‡ºé‚®ç®±è®¿é—®å¯†é’¥
- ğŸ“± **ç§»åŠ¨ç«¯ä¼˜åŒ–** - å®Œæ•´åŠŸèƒ½æ”¯æŒï¼Œå“åº”å¼è®¾è®¡

### ç»Ÿè®¡åŠŸèƒ½
- ğŸ“ˆ **é¡¶éƒ¨ç»Ÿè®¡æ ** - å®æ—¶æ˜¾ç¤ºä»Šæ—¥æ”¶ä»¶ã€æ€»æ”¶ä»¶ã€æ´»è·ƒé‚®ç®±
- ğŸ“‰ **12å°æ—¶è¶‹åŠ¿å›¾** - è¿·ä½ æŸ±çŠ¶å›¾å±•ç¤ºè¿‘æœŸé‚®ä»¶è¶‹åŠ¿
- ğŸ† **å‘ä»¶äººæ’è¡Œ** - Top 5 å‘ä»¶äººç»Ÿè®¡
- ğŸ• **24å°æ—¶åˆ†å¸ƒ** - æŒ‰å°æ—¶ç»Ÿè®¡é‚®ä»¶æ¥æ”¶é‡
- ğŸ’¾ **ç‹¬ç«‹ç»Ÿè®¡å­˜å‚¨** - åˆ é™¤é‚®ä»¶ä¸å½±å“å†å²ç»Ÿè®¡æ•°æ®

### ä½“éªŒä¼˜åŒ–
- âš¡ **å®æ—¶åˆ·æ–°** - æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°æ”¶ä»¶ç®±
- ğŸ”” **æ¡Œé¢é€šçŸ¥** - æ–°é‚®ä»¶åˆ°è¾¾æ—¶æµè§ˆå™¨æ¨é€é€šçŸ¥
- âŒ¨ï¸ **å¿«æ·é”®æ”¯æŒ** - Råˆ·æ–°ã€Næ–°å»ºã€Cå¤åˆ¶ã€Escå…³é—­
- ğŸ“¥ **åŸå§‹é‚®ä»¶ä¸‹è½½** - æ”¯æŒä¸‹è½½ .eml æ ¼å¼åŸå§‹é‚®ä»¶

## ğŸ“¦ æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| è¿è¡Œæ—¶ | Cloudflare Workers |
| æ•°æ®åº“ | Cloudflare D1 (SQLite) |
| é‚®ä»¶æœåŠ¡ | Cloudflare Email Routing |
| å‰ç«¯æ¡†æ¶ | Alpine.js + Tailwind CSS |
| é‚®ä»¶è§£æ | postal-mime |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- [Node.js](https://nodejs.org/) >= 18
- [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/)
- å·²å¯ç”¨ Workers å’Œ D1 çš„ Cloudflare è´¦æˆ·

### å®‰è£…éƒ¨ç½²

```bash
# å…‹éš†ä»“åº“
git clone https://git.specialz.org/Specialz/Mailfly.git
cd Mailfly

# å®‰è£…ä¾èµ–
npm install

# å¤åˆ¶é…ç½®æ–‡ä»¶å¹¶ä¿®æ”¹
cp wrangler.example.jsonc wrangler.jsonc
# ç¼–è¾‘ wrangler.jsoncï¼Œå¡«å…¥ä½ çš„ database_id å’ŒåŸŸå

# åˆ›å»º D1 æ•°æ®åº“
wrangler d1 create mailfly-db

# åˆå§‹åŒ–æ•°æ®åº“ç»“æ„
wrangler d1 execute mailfly-db --file=schema.sql

# éƒ¨ç½²
wrangler deploy
```

### é…ç½®é‚®ä»¶è·¯ç”±

1. è¿›å…¥ Cloudflare æ§åˆ¶å° â†’ ç”µå­é‚®ä»¶ â†’ Email Routing
2. æ·»åŠ åŸŸåå¹¶éªŒè¯ DNS è®°å½•
3. åˆ›å»º Catch-all è§„åˆ™ â†’ å‘é€åˆ° Worker â†’ é€‰æ‹© `mailfly`

### é…ç½®é‚®ä»¶è½¬å‘

è½¬å‘åŠŸèƒ½ä½¿ç”¨ Cloudflare Email Routing çš„ `message.forward()` APIï¼Œè½¬å‘ç›®æ ‡é‚®ç®±éœ€è¦å…ˆåœ¨ Cloudflare æ§åˆ¶å°éªŒè¯ï¼š

1. è¿›å…¥ Cloudflare Dashboard â†’ Email â†’ Email Routing â†’ Destination addresses
2. æ·»åŠ å¹¶éªŒè¯è½¬å‘ç›®æ ‡é‚®ç®±

## ğŸ“¡ API æ¥å£

### è´¦æˆ·ç³»ç»Ÿ

Mailfly æ”¯æŒä¸¤ç§ä½¿ç”¨æ¨¡å¼ï¼š

#### åŒ¿åæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
- åˆ›å»ºé‚®ç®±æ—¶è‡ªåŠ¨ç”Ÿæˆè®¿é—®å¯†é’¥ï¼ˆ`access_key`ï¼‰
- å¯†é’¥å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°
- æ‰€æœ‰é‚®ç®±æ“ä½œéœ€æä¾›å¯†é’¥å‚æ•° `?key=xxx`
- é€‚åˆä¸´æ—¶ä½¿ç”¨ï¼Œæ— éœ€æ³¨å†Œ

#### è´¦æˆ·æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
- æ³¨å†Œè´¦æˆ·åè·å¾— JWT Tokenï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰
- ä½¿ç”¨ `Authorization: Bearer <token>` è®¤è¯
- åˆ›å»ºçš„é‚®ç®±è‡ªåŠ¨å…³è”è´¦æˆ·
- å¯è·¨è®¾å¤‡è®¿é—®è‡ªå·±çš„é‚®ç®±

### è´¦æˆ·æ¥å£

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| `POST` | `/api/auth/register` | æ³¨å†Œè´¦æˆ·ï¼ˆç”¨æˆ·åâ‰¥3å­—ç¬¦ï¼Œå¯†ç â‰¥6å­—ç¬¦ï¼‰ |
| `POST` | `/api/auth/login` | ç™»å½•è·å– JWT Token |

**æ³¨å†Œç¤ºä¾‹ï¼š**
```bash
curl -X POST https://your-worker.dev/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "user123", "password": "password123"}'
```

**ç™»å½•ç¤ºä¾‹ï¼š**
```bash
curl -X POST https://your-worker.dev/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "user123", "password": "password123"}'
```

### Token ç®¡ç†ï¼ˆéœ€è¦ Admin Tokenï¼‰

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| `GET` | `/api/tokens` | è·å–æ‰€æœ‰ API Token |
| `POST` | `/api/tokens` | åˆ›å»ºæ–° Token |
| `DELETE` | `/api/tokens/:token` | åˆ é™¤ Token |

Admin Token åœ¨ `wrangler.jsonc` ä¸­é…ç½®çš„ `ADMIN_TOKEN`ã€‚

### åŸºç¡€æ¥å£

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| `GET` | `/` | Web ç•Œé¢ |
| `GET` | `/api/domains` | è·å–å¯ç”¨åŸŸååˆ—è¡¨ |
| `GET` | `/api/stats` | è·å–å…¨å±€ç»Ÿè®¡æ•°æ® |

### é‚®ç®±ç®¡ç†

æ‰€æœ‰é‚®ç®±æ“ä½œéœ€è¦æä¾›è®¿é—®å¯†é’¥æˆ– JWT Tokenï¼š

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| `POST` | `/api/inbox` | åˆ›å»ºæ–°é‚®ç®±ï¼ˆè¿”å› access_keyï¼‰ |
| `GET` | `/api/inbox/:address?key=xxx` | è·å–é‚®ç®±é‚®ä»¶åˆ—è¡¨ |
| `DELETE` | `/api/inbox/:address` | åˆ é™¤é‚®ç®±ï¼ˆéœ€åœ¨ body ä¸­æä¾› keyï¼‰ |
| `POST` | `/api/inbox/:address/renew` | ç»­æœŸé‚®ç®±ï¼ˆéœ€åœ¨ body ä¸­æä¾› keyï¼‰ |
| `POST` | `/api/inbox/:address/forward` | è®¾ç½®è½¬å‘åœ°å€ï¼ˆéœ€åœ¨ body ä¸­æä¾› keyï¼‰ |
| `GET` | `/api/inbox/:address/stats?key=xxx` | è·å–é‚®ç®±ç»Ÿè®¡ |

### é‚®ä»¶æ“ä½œ

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| `GET` | `/api/mail/:id?key=xxx` | è·å–é‚®ä»¶å†…å®¹ï¼ˆå«è‡ªåŠ¨æå–çš„éªŒè¯ç ï¼‰ |
| `GET` | `/api/mail/:id?format=raw&key=xxx` | ä¸‹è½½åŸå§‹ .eml æ–‡ä»¶ |
| `DELETE` | `/api/mail/:id` | åˆ é™¤é‚®ä»¶ï¼ˆéœ€åœ¨ body ä¸­æä¾› keyï¼‰ |

### éªŒè¯ç æå–

`GET /api/mail/:id` è¿”å›çš„ JSON ä¸­åŒ…å« `code` å­—æ®µï¼Œè‡ªåŠ¨ä»é‚®ä»¶ä¸»é¢˜å’Œæ­£æ–‡ä¸­æå–éªŒè¯ç ï¼š

```json
{
  "id": "xxx",
  "from_addr": "noreply@example.com",
  "subject": "æ‚¨çš„éªŒè¯ç æ˜¯ 123456",
  "body": "...",
  "code": "123456"
}
```

æ”¯æŒçš„éªŒè¯ç æ ¼å¼ï¼š
- 4-8 ä½çº¯æ•°å­—ï¼ˆå¦‚ `123456`ï¼‰
- 4-8 ä½å­—æ¯æ•°å­—æ··åˆï¼ˆå¦‚ `A1B2C3`ï¼‰
- å…³é”®è¯åŒ¹é…ï¼š`éªŒè¯ç `ã€`code`ã€`ç `

### ç¤ºä¾‹

**åˆ›å»ºé‚®ç®±ï¼ˆåŒ¿åæ¨¡å¼ï¼‰ï¼š**
```bash
curl -X POST https://your-worker.dev/api/inbox \
  -H "Content-Type: application/json" \
  -d '{"prefix": "test", "domain": "example.com"}'
# è¿”å›: {"address": "test@example.com", "expires_at": 1234567890, "access_key": "key_xxx"}
```

**è·å–é‚®ç®±é‚®ä»¶ï¼ˆä½¿ç”¨å¯†é’¥ï¼‰ï¼š**
```bash
curl "https://your-worker.dev/api/inbox/test@example.com?key=key_xxx"
```

**è®¾ç½®è½¬å‘ï¼š**
```bash
curl -X POST https://your-worker.dev/api/inbox/test@example.com/forward \
  -H "Content-Type: application/json" \
  -d '{"forward_to": "your@email.com", "key": "key_xxx"}'
```

**ä½¿ç”¨ JWT Tokenï¼ˆè´¦æˆ·æ¨¡å¼ï¼‰ï¼š**
```bash
# ç™»å½•è·å– token
TOKEN=$(curl -X POST https://your-worker.dev/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "user123", "password": "password123"}' | jq -r .token)

# ä½¿ç”¨ token åˆ›å»ºé‚®ç®±
curl -X POST https://your-worker.dev/api/inbox \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"prefix": "test"}'
```

## âš™ï¸ é…ç½®è¯´æ˜

ç¼–è¾‘ `wrangler.jsonc`ï¼š

```jsonc
{
  "name": "mailfly",
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "mailfly-db",
      "database_id": "your-database-id-here"
    }
  ],
  "vars": {
    "DOMAINS": "example.com,mail.example.org",  // é€—å·åˆ†éš”çš„åŸŸååˆ—è¡¨
    "MAIL_TTL": "3600",                          // é‚®ç®±æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
    "ADMIN_TOKEN": "your-secret-admin-token"     // ç®¡ç†å‘˜ Tokenï¼ˆç”¨äºç®¡ç† API Tokenï¼‰
  },
  "triggers": {
    "crons": ["0 0 * * *"]                      // æ¯æ—¥æ¸…ç†è®¡åˆ’
  }
}
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
mailfly/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js      # å…¥å£æ–‡ä»¶ï¼ˆfetchã€emailã€scheduled å¤„ç†å™¨ï¼‰
â”‚   â”œâ”€â”€ api.js        # HTTP API è·¯ç”±å’Œå‰ç«¯é¡µé¢
â”‚   â””â”€â”€ email.js      # é‚®ä»¶æ¥æ”¶å¤„ç†å™¨ï¼ˆå«è½¬å‘é€»è¾‘ï¼‰
â”œâ”€â”€ schema.sql        # D1 æ•°æ®åº“ç»“æ„
â”œâ”€â”€ wrangler.example.jsonc  # é…ç½®ç¤ºä¾‹
â””â”€â”€ package.json
```

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

```sql
-- é‚®ç®±è¡¨
CREATE TABLE inboxes (
    address TEXT PRIMARY KEY,
    created_at INTEGER NOT NULL,
    expires_at INTEGER NOT NULL,
    forward_to TEXT,
    access_key TEXT NOT NULL,
    user_id TEXT
);

-- é‚®ä»¶è¡¨
CREATE TABLE emails (
    id TEXT PRIMARY KEY,
    inbox_address TEXT NOT NULL,
    from_addr TEXT NOT NULL,
    subject TEXT,
    body TEXT,
    raw TEXT,
    received_at INTEGER NOT NULL
);

-- ç»Ÿè®¡è¡¨ï¼ˆç‹¬ç«‹å­˜å‚¨ï¼Œåˆ é™¤é‚®ä»¶ä¸å½±å“ç»Ÿè®¡ï¼‰
CREATE TABLE stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    from_addr TEXT NOT NULL,
    received_at INTEGER NOT NULL
);

-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at INTEGER NOT NULL
);

-- API Token è¡¨
CREATE TABLE api_tokens (
    token TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    created_at INTEGER NOT NULL
);
```

## âŒ¨ï¸ å¿«æ·é”®

| å¿«æ·é”® | åŠŸèƒ½ |
|--------|------|
| `R` | åˆ·æ–°é‚®ä»¶åˆ—è¡¨ |
| `N` | åˆ›å»ºæ–°é‚®ç®± |
| `C` | å¤åˆ¶å½“å‰é‚®ç®±åœ°å€ |
| `Esc` | å…³é—­é‚®ä»¶è¯¦æƒ… |

## ğŸ¤ å‚ä¸è´¡çŒ®

æ¬¢è¿æäº¤ Pull Requestï¼

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/amazing`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add amazing feature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/amazing`)
5. å‘èµ· Pull Request

## ğŸ“„ å¼€æºåè®®

æœ¬é¡¹ç›®åŸºäº MIT åè®®å¼€æº - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---

<p align="center">
  Made with â¤ï¸ by <a href="https://git.specialz.org/Specialz">Specialz</a>
</p>
